<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>„ÉÜ„Çπ„Éà5</title>
    <link rel="icon" href="https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png" type="image/png">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fff; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 0.8s ease, visibility 0.8s; }
        #loader-logo-img { max-width: 200px; }
        .info-panel { position: absolute; top: 15px; left: 15px; z-index: 1000; color: #333; font-family: sans-serif; text-shadow: 1px 1px 2px white; pointer-events: none; }
        #time-display { font-size: 24px; font-weight: bold; }
        .popup-header { padding: 10px 15px; font-weight: bold; font-size: 14px; background: #2a2a2a; color: #fff; }
        .live-camera-main-popup .mapboxgl-popup-content { background: #1a1a1a; color: #fff; border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.6); }
        .live-camera-main-popup .mapboxgl-popup-tip { display: none !important; }
    </style>
</head>
<body>

<div id="loader">
    <img id="loader-logo-img" src="https://raw.githubusercontent.com/sapporo-geolab/logo-sunasapo-img/main/logo_sunasapo.png">
    <div style="margin-top:20px; color:#666; font-size:12px;">ÊúÄÊñ∞„ÅÆÂÜ¨„Éû„ÉÉ„Éó„ÇíÊßãÁØâ‰∏≠...</div>
</div>

<div id="map"></div>

<div class="info-panel">
    <div id="date-display">----Âπ¥--Êúà--Êó•</div>
    <div id="time-display">00:00:00</div>
</div>

<script>
    const cameraCsvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/3d64bf54acce4d6095738dc1383cfb57/raw/a7f3c44bb88006391b84194e1cf694d54b4b27c2/livecamera.csv';
    const initialCenter = [141.3508, 43.0645]; 
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FwcG9yby1nZW9sYWIiLCJhIjoiY21rNnBtdnllMHY0ZDNmcHdudWxheXh2YyJ9.XmcyBM52az-vYC6Tigqduw';

    const map = new mapboxgl.Map({ 
        container: 'map', 
        // ÂÖ¨Âºè„ÅÆ„Éê„Éº„Ç∏„Éß„É≥ÊåáÂÆöURL„Çí‰Ωø„ÅÜ
        style: 'mapbox://styles/mapbox/standard-v1', 
        center: initialCenter, 
        zoom: 15, 
        pitch: 60,
        attributionControl: false,
        // „Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàêÊôÇ„Å´ÂÜ¨„ÅÆË®≠ÂÆö„ÇíÊ≥®ÂÖ•
        config: {
            basemap: {
                theme: 'winter',
                lightPreset: 'day', // Â§ïÊñπ„Å´Ë¶ã„Åà„Å™„ÅÑ„Çà„ÅÜÊòºÈñì„Å´Ë®≠ÂÆö
                show3dObjects: true
            }
        }
    });

    map.on('style.load', () => {
        // „É≠„Éº„ÉâÂæå„Å´„ÇÇÂøµÊäº„Åó„ÅßË®≠ÂÆö
        map.setConfigProperty('basemap', 'theme', 'winter');
        map.setFog({
            'range': [0.5, 10],
            'color': '#ffffff',
            'high-color': '#eef2f5',
            'space-color': '#eef2f5',
            'horizon-blend': 0.1
        });
    });

    map.on('load', async () => {
        // „Ç´„É°„É©„Ç¢„Ç§„Ç≥„É≥ËøΩÂä†
        const svg = `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="white" stroke="#333" stroke-width="2"/><path d="M18 22h20a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H18a2 2 0 0 1-2-2V24a2 2 0 0 1 2-2zm24 6l8-4v16l-8-4v-8z" fill="#333"/></svg>`;
        const img = new Image();
        img.onload = () => map.addImage('camera-custom', img);
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);

        // CSV: „É©„Ç§„Éñ„Ç´„É°„É©
        Papa.parse(cameraCsvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: (results) => {
                const features = results.data.map(row => {
                    const dispTitle = row['„Çø„Ç§„Éà„É´'] || row['No'] || "‰∏çÊòé";
                    const latLngStr = row['Á∑ØÂ∫¶ÁµåÂ∫¶'] || "";
                    const coords = latLngStr.split(',').map(s => parseFloat(s.trim()));
                    const videoUrl = row['URL'] || "";
                    let videoId = "";
                    if (videoUrl.includes('v=')) videoId = videoUrl.split('v=')[1].split('&')[0];
                    else if (videoUrl.includes('youtu.be/')) videoId = videoUrl.split('youtu.be/')[1].split('?')[0];

                    if (coords.length === 2 && !isNaN(coords[0])) {
                        return { 'type': 'Feature', 'properties': { 'title': dispTitle, 'videoId': videoId }, 'geometry': { 'type': 'Point', 'coordinates': [coords[1], coords[0]] } };
                    }
                    return null;
                }).filter(f => f !== null);

                map.addSource('live-cameras', { 'type': 'geojson', 'data': { 'type': 'FeatureCollection', 'features': features } });
                map.addLayer({ 'id': 'camera-layer', 'type': 'symbol', 'source': 'live-cameras', 'slot': 'top', 'layout': { 'icon-image': 'camera-custom', 'icon-size': 0.6, 'icon-allow-overlap': true } });
            }
        });

        // CSV: Á†ÇÁÆ±
        const sandboxCsvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ca0f9f45e8a5e2064678f14eb8e7e933/raw/33abeeab3374bc93c97d208c90056b7355c04802/h301.csv';
        Papa.parse(sandboxCsvUrl, {
            download: true, header: true, complete: async (res) => {
                const gistUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ef76bf0034584f3c6ee30d7489f7f427/raw/graphics.js';
                const script = await fetch(gistUrl).then(r => r.text());
                let sandboxData = { type: 'FeatureCollection', features: [] };
                new Function('map', 'rawData', 'sandboxData', script + '\nupdateSandboxGraphics(map, rawData, sandboxData);')(map, res.data, sandboxData);
                map.addSource('sunabako-source', { type: 'geojson', data: sandboxData });
                map.addLayer({ 'id': 'sunabako-layer', 'type': 'fill-extrusion', 'source': 'sunabako-source', 'slot': 'top', 'paint': { 'fill-extrusion-color': ['get', 'color'], 'fill-extrusion-height': 5, 'fill-extrusion-base': 0 } });
            }
        });

        // „Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
        map.on('click', 'camera-layer', (e) => {
            const f = e.features[0];
            const { title, videoId } = f.properties;
            map.flyTo({ center: f.geometry.coordinates, zoom: 18, pitch: 70 });
            new mapboxgl.Popup({ className: 'live-camera-main-popup', anchor: 'bottom', closeButton: true })
                .setLngLat(f.geometry.coordinates)
                .setHTML(`<div class="popup-header">üé• ${title}</div><div style="width:100%; aspect-ratio:16/9; background:#000;"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>`)
                .addTo(map);
        });

        setTimeout(hideLoader, 1000);
    });

    function hideLoader() { const loader = document.getElementById('loader'); loader.style.opacity = '0'; setTimeout(() => { loader.style.visibility = 'hidden'; }, 800); }
    setInterval(() => { const now = new Date(); document.getElementById('date-display').textContent = now.toLocaleDateString('ja-JP'); document.getElementById('time-display').textContent = now.toLocaleTimeString('ja-JP', {hour12:false}); }, 1000);
</script>
</body>
</html>
