<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>ãƒ†ã‚¹ãƒˆç’°å¢ƒ</title>
    <link rel="icon" href="https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png" type="image/png">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fff; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 0.8s ease, visibility 0.8s; }
        #loader-logo-img { max-width: 200px; }
        .info-panel { position: absolute; top: 15px; left: 15px; z-index: 1000; color: #333; font-family: sans-serif; text-shadow: 1px 1px 2px white; pointer-events: none; }
        #time-display { font-size: 24px; font-weight: bold; }
        .live-camera-popup .mapboxgl-popup-content { background: #1a1a1a; color: #fff; border-radius: 12px; padding: 0; overflow: hidden; border: 1px solid #444; }
        .live-camera-popup .mapboxgl-popup-close-button { color: #fff; font-size: 20px; padding: 5px; z-index: 11; }
    </style>
</head>
<body>

<div id="loader">
    <img id="loader-logo-img" src="https://raw.githubusercontent.com/sapporo-geolab/logo-sunahako-img/main/logo_sunasapo.png">
    <div style="margin-top:20px; color:#666; font-size:12px;">ãƒžãƒƒãƒ—ã‚’èµ·å‹•ä¸­...</div>
</div>

<div id="map"></div>

<div class="info-panel">
    <div id="date-display">----å¹´--æœˆ--æ—¥</div>
    <div id="time-display">00:00:00</div>
</div>

<script>
    const cameraCsvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/3d64bf54acce4d6095738dc1383cfb57/raw/a7f3c44bb88006391b84194e1cf694d54b4b27c2/livecamera.csv';
    const initialCenter = [141.3508, 43.0645]; 
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FwcG9yby1nZW9sYWIiLCJhIjoiY21rNnBtdnllMHY0ZDNmcHdudWxheXh2YyJ9.XmcyBM52az-vYC6Tigqduw';

    const map = new mapboxgl.Map({ 
        container: 'map', 
        style: 'mapbox://styles/mapbox/standard', 
        center: initialCenter, 
        zoom: 14, 
        pitch: 45,
        attributionControl: false 
    });

    let rawData = [], sandboxData = { type: 'FeatureCollection', features: [] };

    map.on('style.load', () => {
        map.setConfigProperty('basemap', 'lightPreset', 'day');
        map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
        map.setConfigProperty('basemap', 'showPlaceLabels', false);
    });

    map.on('load', async () => {
        const svg = `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="black" stroke="cyan" stroke-width="2"/><path d="M18 22h20a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H18a2 2 0 0 1-2-2V24a2 2 0 0 1 2-2zm24 6l8-4v16l-8-4v-8z" fill="white"/></svg>`;
        const img = new Image();
        img.onload = () => map.addImage('camera-custom', img);
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);

        Papa.parse(cameraCsvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                const features = results.data.map(row => {
                    // --- åˆ—ã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„ ---
                    // 1. ã‚¿ã‚¤ãƒˆãƒ«ï¼š ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€åˆ—ãŒã‚ã‚Œã°ä½¿ã„ã€ãªã‘ã‚Œã°ã€ŒNoã€ã‚’ä½¿ã†
                    const dispTitle = row['ã‚¿ã‚¤ãƒˆãƒ«'] || row['No'] || "ä¸æ˜Ž";
                    
                    // 2. ç·¯åº¦çµŒåº¦ï¼š ã€Œç·¯åº¦çµŒåº¦ã€åˆ—ã‚’åˆ†å‰²
                    const latLngStr = row['ç·¯åº¦çµŒåº¦'] || "";
                    const coords = latLngStr.split(',').map(s => parseFloat(s.trim()));
                    
                    // 3. å‹•ç”»IDï¼š ã€ŒURLã€åˆ—ã‹ã‚‰æŠ½å‡º
                    const videoUrl = row['URL'] || "";
                    let videoId = "";
                    if (videoUrl.includes('v=')) {
                        videoId = videoUrl.split('v=')[1].split('&')[0];
                    } else if (videoUrl.includes('youtu.be/')) {
                        videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                    }

                    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        return {
                            'type': 'Feature',
                            'properties': { 
                                'title': dispTitle.includes('ã‚«ãƒ¡ãƒ©') ? dispTitle : `ã‚«ãƒ¡ãƒ©ï¼š${dispTitle}`, 
                                'videoId': videoId 
                            },
                            'geometry': { 
                                'type': 'Point', 
                                'coordinates': [coords[1], coords[0]] 
                            }
                        };
                    }
                    return null;
                }).filter(f => f !== null);

                map.addSource('live-cameras', {
                    'type': 'geojson',
                    'data': { 'type': 'FeatureCollection', 'features': features }
                });

                map.addLayer({
                    'id': 'camera-layer', 'type': 'symbol', 'source': 'live-cameras', 'slot': 'top',
                    'layout': { 'icon-image': 'camera-custom', 'icon-size': 0.6, 'icon-allow-overlap': true }
                });
            }
        });

        // ç ‚ç®±èª­ã¿è¾¼ã¿
        try {
            const sandboxCsvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ca0f9f45e8a5e2064678f14eb8e7e933/raw/33abeeab3374bc93c97d208c90056b7355c04802/h301.csv';
            Papa.parse(sandboxCsvUrl, {
                download: true, header: true, complete: async (res) => {
                    rawData = res.data;
                    const gistUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ef76bf0034584f3c6ee30d7489f7f427/raw/graphics.js';
                    const script = await fetch(gistUrl).then(r => r.text());
                    new Function('map', 'rawData', 'sandboxData', script + '\nupdateSandboxGraphics(map, rawData, sandboxData);')(map, rawData, sandboxData);
                    map.addSource('sunabako-source', { type: 'geojson', data: sandboxData });
                    map.addLayer({
                        'id': 'sunabako-layer', 'type': 'fill-extrusion', 'source': 'sunabako-source', 'slot': 'top',
                        'paint': { 'fill-extrusion-color': ['get', 'color'], 'fill-extrusion-height': 5, 'fill-extrusion-base': 0 }
                    });
                }
            });
        } catch (e) {}

        map.on('click', 'camera-layer', (e) => {
            const f = e.features[0];
            map.flyTo({ center: f.geometry.coordinates, zoom: 17, pitch: 60 });
            new mapboxgl.Popup({ maxWidth: '320px', className: 'live-camera-popup', offset: 30 })
                .setLngLat(f.geometry.coordinates)
                .setHTML(`
                    <div style="padding:10px; font-weight:bold; font-size:14px; color:white; background:#333;">ðŸŽ¥ ${f.properties.title}</div>
                    <div style="width:100%; aspect-ratio:16/9; background:#000;">
                        <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${f.properties.videoId}?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                `).addTo(map);
        });

        map.on('mouseenter', 'camera-layer', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'camera-layer', () => map.getCanvas().style.cursor = '');
        setTimeout(hideLoader, 1000);
    });

    function hideLoader() {
        const loader = document.getElementById('loader');
        loader.style.opacity = '0';
        setTimeout(() => { loader.style.visibility = 'hidden'; }, 800);
    }

    setInterval(() => {
        const now = new Date();
        document.getElementById('date-display').textContent = now.toLocaleDateString('ja-JP');
        document.getElementById('time-display').textContent = now.toLocaleTimeString('ja-JP', {hour12:false});
    }, 1000);
</script>
</body>
</html>
