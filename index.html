<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>„ÉÜ„Çπ„ÉàÁí∞Â¢É</title>
    <link rel="icon" href="https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png" type="image/png">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fff; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 0.8s ease, visibility 0.8s; }
        #loader-logo-img { max-width: 200px; }
        .info-panel { position: absolute; top: 15px; left: 15px; z-index: 1000; color: #333; font-family: sans-serif; text-shadow: 1px 1px 2px white; pointer-events: none; }
        #time-display { font-size: 24px; font-weight: bold; }
        
        /* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        .live-camera-popup .mapboxgl-popup-content { background: #1a1a1a; color: #fff; border-radius: 12px; padding: 0; overflow: hidden; border: 1px solid #444; }
        .live-camera-popup .mapboxgl-popup-close-button { color: #fff; font-size: 20px; padding: 5px; z-index: 11; }
        .yt-btn { display: block; background: #ff0000; color: white; text-align: center; padding: 10px; text-decoration: none; font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

<div id="loader">
    <img id="loader-logo-img" src="https://raw.githubusercontent.com/sapporo-geolab/logo-sunahako-img/main/logo_sunasapo.png">
    <div style="margin-top:20px; color:#666; font-size:12px;">„Éû„ÉÉ„Éó„ÇíËµ∑Âãï‰∏≠...</div>
</div>

<div id="map"></div>

<div class="info-panel">
    <div id="date-display">----Âπ¥--Êúà--Êó•</div>
    <div id="time-display">00:00:00</div>
</div>

<script>
    // 1. Ë®≠ÂÆö
    const initialCoords = [141.36234657793966, 43.060337411964575];
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FwcG9yby1nZW9sYWIiLCJhIjoiY21rbm4yOXE5MDdwNDNkczh5MnlqNnI4eCJ9.Utenu-9vEz56uGUETeWS1g';

    const map = new mapboxgl.Map({ 
        container: 'map', 
        style: 'mapbox://styles/mapbox/standard', 
        center: initialCoords, 
        zoom: 16, 
        pitch: 45,
        attributionControl: false 
    });

    let rawData = [], sandboxData = { type: 'FeatureCollection', features: [] };

    // --- A. „É©„Ç§„Éñ„Ç´„É°„É©„Éá„Éº„Çø„ÅÆÈÖçÂàóÁÆ°ÁêÜ ---
    const cameraData = [
        { title: 'ÂâµÊàêÂ∑ùÂÖ¨Âúí‰ªòËøë', videoId: 'CdesNZ150HE', coords: [141.36234657793966, 43.060337411964575] },
        { title: 'Â§ßÈÄöÂÖ¨ÂúíÊñπÈù¢', videoId: 'I1kJB1jdGo0', coords: [141.3645, 43.0615] },
        { title: '„ÉÜ„Çπ„Éà„Ç´„É°„É©3', videoId: '_qQFsKQ0A0I', coords: [141.3600, 43.0590] },
        { title: '„ÉÜ„Çπ„Éà„Ç´„É°„É©4', videoId: '0fGNQXoGSnk', coords: [141.3650, 43.0595] },
        { title: '„ÉÜ„Çπ„Éà„Ç´„É°„É©5', videoId: 'gaNLXSEUVRw', coords: [141.3585, 43.0620] }
    ];

    map.on('style.load', () => {
        map.setConfigProperty('basemap', 'lightPreset', 'day');
        map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
        map.setConfigProperty('basemap', 'showPlaceLabels', false);
    });

    map.on('load', async () => {
        // --- „É©„Ç§„Éñ„Ç´„É°„É©„Ç¢„Ç§„Ç≥„É≥„ÅÆË®≠ÂÆö ---
        const svg = `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="black" stroke="cyan" stroke-width="2"/><path d="M18 22h20a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H18a2 2 0 0 1-2-2V24a2 2 0 0 1 2-2zm24 6l8-4v16l-8-4v-8z" fill="white"/></svg>`;
        const img = new Image();
        img.onload = () => map.addImage('camera-custom', img);
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);

        // ÈÖçÂàó„Åã„ÇâGeoJSON„ÇíÁîüÊàê
        const cameraFeatures = cameraData.map(cam => ({
            'type': 'Feature',
            'properties': { 'title': cam.title, 'videoId': cam.videoId },
            'geometry': { 'type': 'Point', 'coordinates': cam.coords }
        }));

        map.addSource('live-cameras', {
            'type': 'geojson',
            'data': { 'type': 'FeatureCollection', 'features': cameraFeatures }
        });

        map.addLayer({
            'id': 'camera-layer', 'type': 'symbol', 'source': 'live-cameras', 'slot': 'top',
            'layout': { 'icon-image': 'camera-custom', 'icon-size': 0.7, 'icon-allow-overlap': true }
        });

        // --- Á†ÇÁÆ±„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø ---
        try {
            const csvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ca0f9f45e8a5e2064678f14eb8e7e933/raw/33abeeab3374bc93c97d208c90056b7355c04802/h301.csv';
            Papa.parse(csvUrl, {
                download: true, header: true, complete: async (res) => {
                    rawData = res.data;
                    const gistUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ef76bf0034584f3c6ee30d7489f7f427/raw/graphics.js';
                    const script = await fetch(gistUrl).then(r => r.text());
                    new Function('map', 'rawData', 'sandboxData', script + '\nupdateSandboxGraphics(map, rawData, sandboxData);')(map, rawData, sandboxData);
                    
                    map.addSource('sunabako-source', { type: 'geojson', data: sandboxData });
                    map.addLayer({
                        'id': 'sunabako-layer', 'type': 'fill-extrusion', 'source': 'sunabako-source', 'slot': 'top',
                        'paint': { 'fill-extrusion-color': ['get', 'color'], 'fill-extrusion-height': 5, 'fill-extrusion-base': 0 }
                    });
                }
            });
        } catch (e) { console.error("Á†ÇÁÆ±Ë™≠„ÅøËæº„ÅøÂ§±Êïó", e); }

        // --- „Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥ („ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà) ---
        map.on('click', 'camera-layer', (e) => {
            const f = e.features[0];
            const { title, videoId } = f.properties;
            map.flyTo({ center: f.geometry.coordinates, zoom: 18.5, pitch: 60 });
            
            new mapboxgl.Popup({ maxWidth: '320px', className: 'live-camera-popup', offset: 30 })
                .setLngLat(f.geometry.coordinates)
                .setHTML(`
                    <div style="padding:10px; font-weight:bold; font-size:14px; color:white; background:#333;">üé• ${title}</div>
                    <div style="width:100%; aspect-ratio:16/9; background:#000;">
                        <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&origin=${window.location.origin}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" class="yt-btn">YouTube„Ç¢„Éó„É™„ÅßÈñã„Åè</a>
                `).addTo(map);
        });

        map.on('mouseenter', 'camera-layer', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'camera-layer', () => map.getCanvas().style.cursor = '');

        setTimeout(hideLoader, 1000);
    });

    function hideLoader() {
        const loader = document.getElementById('loader');
        loader.style.opacity = '0';
        setTimeout(() => { loader.style.visibility = 'hidden'; }, 800);
    }

    setInterval(() => {
        const now = new Date();
        document.getElementById('date-display').textContent = now.toLocaleDateString('ja-JP');
        document.getElementById('time-display').textContent = now.toLocaleTimeString('ja-JP', {hour12:false});
    }, 1000);
</script>
</body>
</html>
